#!/bin/bash

# Script para configurar SSL con Let's Encrypt para imetrics.cl
# Ejecutar en el servidor 147.93.182.94 con permisos de root

echo "ğŸ” Configurando SSL con Let's Encrypt para imetrics.cl..."

# Instalar Certbot si no estÃ¡ instalado
if ! command -v certbot &> /dev/null; then
    echo "ğŸ“¦ Instalando Certbot..."
    apt update
    apt install -y certbot python3-certbot-nginx
fi

# Verificar que nginx estÃ© configurado
if [ ! -f "/etc/nginx/sites-enabled/imetrics.cl" ]; then
    echo "âŒ Error: ConfiguraciÃ³n nginx no encontrada. Ejecuta primero configurar-nginx-imetrics.sh"
    exit 1
fi

# Obtener certificado SSL
echo "ğŸ”‘ Obteniendo certificado SSL..."
certbot --nginx -d imetrics.cl -d www.imetrics.cl --non-interactive --agree-tos --email admin@imetrics.cl

if [ $? -eq 0 ]; then
    echo "âœ… Certificado SSL configurado exitosamente"
    
    # Configurar renovaciÃ³n automÃ¡tica
    echo "ğŸ”„ Configurando renovaciÃ³n automÃ¡tica..."
    (crontab -l 2>/dev/null; echo "0 12 * * * /usr/bin/certbot renew --quiet") | crontab -
    
    echo "âœ… SSL configurado y renovaciÃ³n automÃ¡tica activada"
else
    echo "âŒ Error al configurar SSL"
    exit 1
fi

echo "ğŸ¯ Â¡ConfiguraciÃ³n SSL completada!"