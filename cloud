#!/usr/bin/env node

/**
 * CONFIGURACI√ìN R√ÅPIDA CLOUDFLARE
 * Script simple para configurar HTTPS autom√°ticamente
 */

const https = require('https');

class CloudflareQuickSetup {
  constructor(token) {
    this.token = token;
    this.domain = '147.93.182.94.sslip.io';
    this.subdomain = 'v8g48ggkk8wko4480s8kk4ok';
    this.fullDomain = `${this.subdomain}.${this.domain}`;
    
    this.baseUrl = 'https://api.cloudflare.com/client/v4';
    this.headers = {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${this.token}`
    };
  }

  async setup() {
    console.log('üöÄ CONFIGURACI√ìN R√ÅPIDA CLOUDFLARE');
    console.log('=====================================');
    
    try {
      console.log('üîê Verificando token...');
      await this.verifyToken();
      
      console.log('üåê Obteniendo zona...');
      const zone = await this.getZone();
      
      console.log('üì° Configurando DNS...');
      await this.setupDNS(zone);
      
      console.log('üîí Configurando SSL...');
      await this.setupSSL(zone);
      
      console.log('üîÑ Activando Always Use HTTPS...');
      await this.setupAlwaysHTTPS(zone);
      
      console.log('\nüéâ ¬°CONFIGURACI√ìN COMPLETADA!');
      console.log('=====================================');
      console.log(`üåê Tu URL HTTPS: https://${this.fullDomain}`);
      console.log(`‚è∞ Espera 10-30 minutos para propagaci√≥n`);
      console.log('\nüîë URLs para Google Cloud Console:');
      console.log(`https://${this.fullDomain}/callback`);
      console.log(`https://${this.fullDomain}/auth/callback`);
      console.log(`https://${this.fullDomain}/oauth/callback`);
      console.log(`https://${this.fullDomain}/auth/google/callback`);
      
    } catch (error) {
      console.error('‚ùå Error:', error.message);
      process.exit(1);
    }
  }

  async verifyToken() {
    const response = await this.request('/user/tokens/verify', 'GET');
    if (!response.success) {
      throw new Error('Token inv√°lido');
    }
    console.log('‚úÖ Token v√°lido');
  }

  async getZone() {
    const response = await this.request(`/zones?name=${this.domain}`, 'GET');
    if (!response.success || !response.result.length) {
      throw new Error(`Zona ${this.domain} no encontrada`);
    }
    return response.result[0];
  }

  async setupDNS(zone) {
    // Verificar si existe
    const existing = await this.request(
      `/zones/${zone.id}/dns_records?name=${this.fullDomain}`, 
      'GET'
    );
    
    if (existing.success && existing.result.length > 0) {
      console.log('‚úÖ DNS ya configurado');
      return;
    }
    
    // Crear DNS
    const dnsData = {
      type: 'CNAME',
      name: this.subdomain,
      content: this.fullDomain,
      proxied: true
    };
    
    const response = await this.request(
      `/zones/${zone.id}/dns_records`,
      'POST',
      dnsData
    );
    
    if (!response.success) {
      throw new Error('Error al crear DNS');
    }
    console.log('‚úÖ DNS configurado');
  }

  async setupSSL(zone) {
    const response = await this.request(
      `/zones/${zone.id}/settings/ssl`,
      'PATCH',
      { value: 'full_strict' }
    );
    
    if (!response.success) {
      throw new Error('Error al configurar SSL');
    }
    console.log('‚úÖ SSL configurado');
  }

  async setupAlwaysHTTPS(zone) {
    const response = await this.request(
      `/zones/${zone.id}/settings/always_use_https`,
      'PATCH',
      { value: 'on' }
    );
    
    if (!response.success) {
      throw new Error('Error al activar Always Use HTTPS');
    }
    console.log('‚úÖ Always Use HTTPS activado');
  }

  request(endpoint, method = 'GET', data = null) {
    return new Promise((resolve, reject) => {
      const url = new URL(this.baseUrl + endpoint);
      const options = {
        hostname: url.hostname,
        path: url.pathname + url.search,
        method: method,
        headers: this.headers
      };

      const req = https.request(options, (res) => {
        let body = '';
        res.on('data', chunk => body += chunk);
        res.on('end', () => {
          try {
            resolve(JSON.parse(body));
          } catch (error) {
            reject(new Error('Error al parsear respuesta'));
          }
        });
      });

      req.on('error', reject);
      if (data) req.write(JSON.stringify(data));
      req.end();
    });
  }
}

// Uso del script
if (require.main === module) {
  const token = process.env.CLOUDFLARE_TOKEN;
  
  if (!token) {
    console.log('‚ùå Error: Se requiere token de Cloudflare');
    console.log('\nüìã C√ìMO USAR:');
    console.log('export CLOUDFLARE_TOKEN="tu_token_aqui"');
    console.log('node cloudflare-quick-setup.js');
    console.log('\nüîë Para obtener token:');
    console.log('1. https://dash.cloudflare.com/profile/api-tokens');
    console.log('2. Crear token con permisos: Zone, DNS, SSL/TLS');
    process.exit(1);
  }
  
  const setup = new CloudflareQuickSetup(token);
  setup.setup();
}

module.exports = CloudflareQuickSetup;